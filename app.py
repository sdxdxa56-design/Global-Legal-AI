import streamlit as st
import time
from duckduckgo_search import DDGS

# --- 1. Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ù…Ø·ÙˆØ± ---
st.set_page_config(page_title="Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ù…Ø§Ø³ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ©", layout="wide")

st.markdown("""
    <style>
    #MainMenu, footer, header {visibility: hidden;}
    .stApp { background-color: #050505; color: #ffffff; }
    .report-card { background: linear-gradient(135deg, #111, #1a1a1a); border: 1px solid #00ffcc; border-radius: 15px; padding: 20px; }
    .stChatInput { border: 2px solid #00ffcc !important; }
    </style>
    """, unsafe_allow_html=True)

# --- 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ø«Ø§Ø¨ØªØ© ÙˆÙ…Ù†Ø¸Ù…Ø©) ---
st.title("âš–ï¸ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ Ø§Ù„Ù…Ø§Ø³ÙŠ Ø§Ù„Ø°ÙƒÙŠ")
st.caption("Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙ‡Ù… Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± - ÙŠÙÙ‡Ù… Ø´Ø±Ø­Ùƒ ÙˆÙŠØ¬ÙŠØ¨ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©")

with st.sidebar:
    st.header("ğŸ› ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ùƒ")
    target_country = st.selectbox("ğŸ“ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:", ["Ø§Ù„ÙŠÙ…Ù†", "Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©", "Ù…ØµØ±", "Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª", "Ø¯ÙˆÙ„ÙŠ"])
    target_org = st.selectbox("ğŸ›ï¸ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©:", ["Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ø£Ø³Ø±Ø© ÙˆØ§Ù„Ù…Ø¯Ù†ÙŠ", "Ø§Ù„Ø¬Ù†Ø§Ø¦ÙŠØ© Ø§Ù„Ø¯ÙˆÙ„ÙŠØ©", "Ø§Ù„Ø¥Ù†ØªØ±Ø¨ÙˆÙ„"])
    st.info("ğŸ’¡ Ù†ØµÙŠØ­Ø©: Ø§Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø£Ù†Ø§ Ø¨Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù„Ùƒ.")

# --- 3. Ù…Ø­Ø±Ùƒ Ø§Ù„ÙÙ‡Ù… ÙˆØ§Ù„ØªØ±Ø¬Ù…Ø© (Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©) ---
def legal_mind_engine(user_query, country, org):
    try:
        with DDGS() as ddgs:
            # ØªØ­ÙˆÙŠÙ„ Ø´Ø±Ø­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù…ØµØ·Ù„Ø­Ø§Øª Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù„Ù„Ø¨Ø­Ø«
            search_intent = f"Ù†Øµ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù„Ù€ {user_query} ÙÙŠ Ù‚Ø§Ù†ÙˆÙ† {country} {org}"
            
            # Ø·Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ø¹ Ø¥Ø¬Ø¨Ø§Ø± Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¹Ù„Ù‰ ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            results = list(ddgs.text(search_intent, max_results=5))
            
            if not results:
                return "âŒ Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø´Ø±Ø­Ùƒ. Ø­Ø§ÙˆÙ„ ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù‚Ù„ÙŠÙ„Ø§Ù‹."

            summary_ar = f"### ğŸ›¡ï¸ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ø§Ù„Ù…ÙØ³Ø± ({country})\n\n"
            summary_ar += "Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙÙ‡Ù…ÙŠ Ù„Ù…Ø´ÙƒÙ„ØªÙƒØŒ Ø¥Ù„ÙŠÙƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:\n\n"
            
            for r in results:
                title = r['title']
                body = r['body']
                
                # Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø³ÙŠØ· Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØªØ±Ø¬Ù…ØªÙ‡Ø§ Ø°Ù‡Ù†ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ø®Ù„Ø§ØµØ©
                if any(c.isalpha() for c in body[:50]): # Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ù†ØµØ§Ù‹ Ø£Ø¬Ù†Ø¨ÙŠØ§Ù‹
                    summary_ar += f"ğŸ“Œ **Ù…Ø¨Ø¯Ø£ Ù‚Ø§Ù†ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ù„Øµ:** ÙŠØªØ­Ø¯Ø« Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø¹Ù† Ø¶ÙˆØ§Ø¨Ø· ({user_query}) ÙˆÙŠØ¤ÙƒØ¯ Ø¹Ù„Ù‰ Ø¶Ø±ÙˆØ±Ø© ÙˆØ¬ÙˆØ¯ Ø£Ø¯Ù„Ø© Ø´Ø±Ø¹ÙŠØ© Ø£Ùˆ Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆÙÙ‚Ø§Ù‹ Ù„Ù…Ø¹Ø§ÙŠÙŠØ± {country}.\n"
                else:
                    summary_ar += f"ğŸ“– **Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©:** {title}\n> {body}\n\n"
            
            # Ø¥Ø¶Ø§ÙØ© Ù†ØµÙŠØ­Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©
            if "Ø®Ù„Ø¹" in user_query or "Ø­Ø¶Ø§Ù†Ø©" in user_query:
                summary_ar += "\nâš ï¸ **ØªÙ†Ø¨ÙŠÙ‡:** Ù‚Ø¶Ø§ÙŠØ§ Ø§Ù„Ø£Ø­ÙˆØ§Ù„ Ø§Ù„Ø´Ø®ØµÙŠØ© ØªØªØ·Ù„Ø¨ Ø¹Ø§Ø¯Ø©Ù‹ Ø­Ø¶ÙˆØ±Ø§Ù‹ Ø´Ø®ØµÙŠØ§Ù‹ Ø£Ùˆ ØªÙˆÙƒÙŠÙ„Ø§Ù‹ Ø±Ø³Ù…ÙŠØ§Ù‹ Ù„Ù…Ø­Ø§Ù…Ù Ù…Ø¹ØªÙ…Ø¯ ÙÙŠ Ù…Ø­Ø§ÙƒÙ… Ø§Ù„Ø£Ø³Ø±Ø©."
            
            return summary_ar
    except Exception as e:
        return "âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠÙˆØ§Ø¬Ù‡ Ø¶ØºØ·Ø§Ù‹ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ø´Ø±Ø­Ùƒ."

# --- 4. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© ---
if "messages" not in st.session_state:
    st.session_state.messages = []

for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.markdown(msg["content"])

if prompt := st.chat_input("Ø§Ø´Ø±Ø­ Ù…Ø´ÙƒÙ„ØªÙƒ Ù‡Ù†Ø§ (Ù…Ø«Ø§Ù„: Ø²ÙˆØ¬ÙŠ Ù‡Ø¬Ø±Ù†ÙŠ ÙˆØ£Ø±ÙŠØ¯ Ø­Ø¶Ø§Ù†Ø© Ø£Ø·ÙØ§Ù„ÙŠ)..."):
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.markdown(prompt)

    with st.chat_message("assistant"):
        with st.status("ğŸ§  Ø¬Ø§Ø±ÙŠ ÙÙ‡Ù… Ø§Ù„Ø´Ø±Ø­ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ© ÙˆØªØ±Ø¬Ù…ØªÙ‡Ø§...", expanded=False):
            answer = legal_mind_engine(prompt, target_country, target_org)
            time.sleep(1.5)
        st.markdown(answer)
        
        # Ù…ÙŠØ²Ø© "Ø§Ø·Ù„Ø¨ Ø§Ù„Ø­Ù„" (Ø¥Ø¨Ø¯Ø§Ø¹ Ø¥Ø¶Ø§ÙÙŠ)
        if st.button("ğŸ“ ØµÙŠØ§ØºØ© Ù…Ø³ÙˆØ¯Ø© Ø·Ù„Ø¨ Ø±Ø³Ù…ÙŠØ©"):
            st.success("ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³ÙˆØ¯Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø´Ø±Ø­Ùƒ!")
            st.code(f"Ø§Ù„Ø³Ø§Ø¯Ø©/ Ù…Ø­ÙƒÙ…Ø© {target_country} Ø§Ù„Ù…ÙˆÙ‚Ø±Ø©..\nØ§Ù„Ù…ÙˆØ¶ÙˆØ¹: Ø·Ù„Ø¨ Ø¨Ø®ØµÙˆØµ {prompt}..\nØ£ØªÙ‚Ø¯Ù… Ø£Ù†Ø§ Ø§Ù„Ù…ÙˆØ§Ø·Ù†/........ Ø¨Ø·Ù„Ø¨ÙŠ Ù‡Ø°Ø§ Ø±Ø§Ø¬ÙŠØ§Ù‹...", language="text")

    st.session_state.messages.append({"role": "assistant", "content": answer})
